name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      - name: Verify tag is signed
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # Check if this is an annotated or signed tag (not lightweight)
          # We need to check the tag reference itself, not the commit it points to
          if git rev-parse -q --verify "refs/tags/${TAG_NAME}" > /dev/null; then
            TAG_OBJECT=$(git rev-parse "refs/tags/${TAG_NAME}")
            TAG_TYPE=$(git cat-file -t "$TAG_OBJECT")
            
            if [ "$TAG_TYPE" != "tag" ]; then
              echo "âŒ ERROR: Tag ${TAG_NAME} is a lightweight tag, not an annotated/signed tag"
              echo ""
              echo "To create a signed tag, use:"
              echo "  git tag -s ${TAG_NAME} -m 'Your release message'"
              echo ""
              echo "To create an annotated tag, use:"
              echo "  git tag -a ${TAG_NAME} -m 'Your release message'"
              echo ""
              echo "Releases must use annotated or signed tags for security and authenticity."
              exit 1
            fi
            
            # Check if tag object contains PGP signature
            if git cat-file tag "$TAG_OBJECT" | grep -q "BEGIN PGP SIGNATURE"; then
              echo "âœ… Tag ${TAG_NAME} contains a PGP signature"
              
              # Verify via GitHub API that the signature is valid
              REPO="${{ github.repository }}"
              API_RESPONSE=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
                "https://api.github.com/repos/${REPO}/git/tags/${TAG_OBJECT}")
              
              VERIFICATION=$(echo "$API_RESPONSE" | jq -r '.verification.verified')
              
              if [ "$VERIFICATION" = "true" ]; then
                echo "âœ… GitHub verified the GPG signature as valid"
              else
                REASON=$(echo "$API_RESPONSE" | jq -r '.verification.reason')
                echo "âš ï¸  GitHub could not verify signature (reason: ${REASON})"
                echo "This may be because the signing key is not uploaded to GitHub."
                echo "To add your GPG key: Settings â†’ SSH and GPG keys â†’ New GPG key"
              fi
            else
              echo "âš ï¸  Tag ${TAG_NAME} is annotated but not GPG signed"
              echo "For maximum security, use: git tag -s ${TAG_NAME} -m 'Your message'"
            fi
          else
            echo "âŒ ERROR: Could not find tag ${TAG_NAME}"
            exit 1
          fi
          
          echo "âœ… Tag validation passed (annotated/signed tag required)"
      
      - name: Get tag information
        id: tag_info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          
          # Get the previous tag for changelog
          PREV_TAG=$(git describe --tags --abbrev=0 ${TAG_NAME}^ 2>/dev/null || echo "")
          echo "previous_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          
          # Get tag message (for annotated/signed tags)
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${TAG_NAME})
          echo "tag_message<<EOF" >> $GITHUB_OUTPUT
          echo "${TAG_MESSAGE}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Generate changelog
        id: changelog
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          PREV_TAG="${{ steps.tag_info.outputs.previous_tag }}"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## ðŸ“‹ Changes" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          
          if [ -z "$PREV_TAG" ]; then
            echo "Initial release" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### All Commits" >> $GITHUB_OUTPUT
            git log --pretty=format:"- %s (%h) - @%an" --reverse >> $GITHUB_OUTPUT
          else
            echo "Changes since ${PREV_TAG}:" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            
            # Group commits by type (conventional commits)
            echo "### âœ¨ Features" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"%s (%h) - @%an" --grep="^feat" >> $GITHUB_OUTPUT || echo "_No new features_" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            
            echo "### ðŸ› Bug Fixes" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"- %s (%h) - @%an" --grep="^fix" >> $GITHUB_OUTPUT || echo "_No bug fixes_" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            
            echo "### ðŸ“š Documentation" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"- %s (%h) - @%an" --grep="^docs" >> $GITHUB_OUTPUT || echo "_No documentation changes_" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            
            echo "### ðŸ”§ Maintenance" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"- %s (%h) - @%an" --grep="^chore\|^refactor\|^test\|^ci" >> $GITHUB_OUTPUT || echo "_No maintenance changes_" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            
            echo "### ðŸ“¦ All Changes" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"- %s (%h) - @%an" >> $GITHUB_OUTPUT
          fi
          
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Get contributors
        id: contributors
        run: |
          TAG_NAME="${{ steps.tag_info.outputs.tag_name }}"
          PREV_TAG="${{ steps.tag_info.outputs.previous_tag }}"
          
          echo "contributors<<EOF" >> $GITHUB_OUTPUT
          echo "## ðŸ‘¥ Contributors" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          
          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:"%an" | sort -u | while read name; do
              echo "- @${name}" >> $GITHUB_OUTPUT
            done
          else
            git log ${PREV_TAG}..${TAG_NAME} --pretty=format:"%an" | sort -u | while read name; do
              echo "- @${name}" >> $GITHUB_OUTPUT
            done
          fi
          
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Build addon ZIP
        working-directory: blender_addon
        run: |
          python scripts/build_addon.py
          
          # Rename the ZIP to include version
          VERSION="${{ steps.tag_info.outputs.tag_name }}"
          mv eve_visualizer.zip "eve_visualizer_${VERSION}.zip"
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.tag_info.outputs.tag_name }}
          body: |
            ${{ steps.tag_info.outputs.tag_message }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ${{ steps.contributors.outputs.contributors }}
            
            ---
            
            ## ðŸ“¥ Installation
            
            1. Download `eve_visualizer_${{ steps.tag_info.outputs.tag_name }}.zip`
            2. In Blender: Edit â†’ Preferences â†’ Add-ons â†’ Install
            3. Select the downloaded ZIP file
            4. Enable "EVE Frontier: Starmap Visualizer"
            
            ## ðŸ“– Documentation
            
            - [Features](https://github.com/${{ github.repository }}/blob/${{ steps.tag_info.outputs.tag_name }}/blender_addon/docs/FEATURES.md)
            - [Architecture](https://github.com/${{ github.repository }}/blob/${{ steps.tag_info.outputs.tag_name }}/blender_addon/docs/ARCHITECTURE.md)
            - [Node-Based Strategies](https://github.com/${{ github.repository }}/blob/${{ steps.tag_info.outputs.tag_name }}/blender_addon/docs/NODE_BASED_STRATEGIES.md)
          files: |
            blender_addon/eve_visualizer_${{ steps.tag_info.outputs.tag_name }}.zip
          draft: false
          prerelease: ${{ contains(steps.tag_info.outputs.tag_name, 'alpha') || contains(steps.tag_info.outputs.tag_name, 'beta') || contains(steps.tag_info.outputs.tag_name, 'rc') }}
          generate_release_notes: false  # We're generating our own
